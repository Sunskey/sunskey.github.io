<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunskey.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="做时间的朋友">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunskey">
<meta property="og:url" content="https://sunskey.top/index.html">
<meta property="og:site_name" content="Sunskey">
<meta property="og:description" content="做时间的朋友">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sunskey">
<meta property="article:tag" content="java, hexo, blog, next">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sunskey.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunskey - 日拱一卒，不期而至</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Sunskey" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunskey</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">日拱一卒，不期而至</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning11.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning11.html" class="post-title-link" itemprop="url">如何正确显示随机消息</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-23 10:09:03 / 修改时间：10:16:27" itemprop="dateCreated datePublished" datetime="2021-01-23T10:09:03+08:00">2021-01-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning11.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning11.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="如何正确显示随机消息"><a href="#如何正确显示随机消息" class="headerlink" title="如何正确显示随机消息"></a>如何正确显示随机消息</h3><h4 id="内存临时表"><a href="#内存临时表" class="headerlink" title="内存临时表"></a>内存临时表</h4><p>使用oder by rand()</p>
<p>对于InnoDB表，执行全字段排序会减少磁盘访问，因此会被优先选择。</p>
<p>对于内存表，回表过程只是简单地根据数据行的位置，直接访问内存得到数据，根本不会导致多访问磁盘，从而选择rowid排序。</p>
<p>select word from words order by rand() limit 3;</p>
<h5 id="整个执行过程"><a href="#整个执行过程" class="headerlink" title="整个执行过程"></a>整个执行过程</h5><p>1.创建一个临时表。这个临时表使用的是 memory 引擎，表里有两个字段，第一个字段是 double 类型，为了后面描述方便，记为字段 R，第二个字段是 varchar(64) 类型，记为字段 W。并且，这个表没有建索引。</p>
<p>2.从 words 表中，按主键顺序取出所有的 word 值。对于每一个 word 值，调用 rand() 函数生成一个大于 0 小于 1 的随机小数，并把这个随机小数和 word 分别存入临时表的 R 和 W 字段中，到此，扫描行数是 10000。</p>
<p>3.现在临时表有 10000 行数据了，接下来你要在这个没有索引的内存临时表上，按照字段 R 排序。</p>
<p>4.初始化 sort_buffer。sort_buffer 中有两个字段，一个是 double 类型，另一个是整型。</p>
<p>5.从内存临时表中一行一行地取出 R 值和位置信息（我后面会和你解释这里为什么是“位置信息”），分别存入 sort_buffer 中的两个字段里。</p>
<p>6.这个过程要对内存临时表做全表扫描，此时扫描行数增加 10000，变成了 20000。在 sort_buffer 中根据 R 的值进行排序。注意，这个过程没有涉及到表操作，所以不会增加扫描行数。</p>
<p>7.排序完成后，取出前三个结果的位置信息，依次到内存临时表中取出 word 值，返回给客户端。这个过程中，访问了表的三行数据，总扫描行数变成了 20003</p>
<img src="https://i.loli.net/2021/01/23/zer2NxcJFMV5afg.png" style="zoom:50%;" />

<p>如果你创建的表没有主键，或者把一个表的主键删掉了，那么 InnoDB 会自己生成一个长度为 6 字节的 rowid 来作为主键。</p>
<p>对于有主键的InnoDB表来说，整个rowid就是主键ID。</p>
<p>对于没有主键的InnoDB表来说，这个rowid就是系统生成的。</p>
<p>order by rand() 使用了内存临时表，内存临时表排序的时候使用了rowid排序算法。</p>
<h4 id="磁盘临时表"><a href="#磁盘临时表" class="headerlink" title="磁盘临时表"></a>磁盘临时表</h4><p>tmp_table_size限制了内存表的大小，默认值是16M。如果临时表的大小超过了tmp_table_size，那么内存临时表就会转成磁盘临时表。</p>
<p>磁盘临时表默认使用InnoDB，是由参数Internal_tmp_disk_storage_engine取控制。</p>
<p>MySQL5.6引入：优先队列排序算法，不需要使用临时文件的算法(归并排序），而是采用了优先队列排序算法。</p>
<img src="https://i.loli.net/2021/01/23/DFnrBLS4lY7cAWj.png" style="zoom:40%;" />

<p>总之，不管使用那种类型的临时表，order_by_rand()这种写法都会让计算过程非常复杂，需要大量的扫描行数。</p>
<h4 id="随机排序方法"><a href="#随机排序方法" class="headerlink" title="随机排序方法"></a>随机排序方法</h4><p>1.取得整个表的行数，并记为C.</p>
<p>2.取得Y = floor(C*rand())。</p>
<p>3.再利用你limit Y，1取得一行。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning10.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning10.html" class="post-title-link" itemprop="url">MySQL 加锁规则</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-22 20:47:40" itemprop="dateCreated datePublished" datetime="2021-01-22T20:47:40+08:00">2021-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-23 10:08:50" itemprop="dateModified" datetime="2021-01-23T10:08:50+08:00">2021-01-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning10.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning10.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="加锁规则"><a href="#加锁规则" class="headerlink" title="加锁规则"></a>加锁规则</h3><p>加锁规则里面，包含了两个”原则‘、两个“优化”和一个“bug”。</p>
<p>1.原则1：加锁基本单位是next-key lock。前开后闭区间。</p>
<p>2.原则2：查找过程中访问到的对象才会加锁。</p>
<p>3.优化1：索引上的等值查询，给唯一索引加锁的时候，next-key lock退化为 行锁。</p>
<p>4.优化2：索引上的等值查询，向右遍历且最后一个不满足等值条件的时候，next-key lock退化为间隙锁。</p>
<p>5.一个bug：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</p>
<img src="https://i.loli.net/2021/01/23/6ChDo3XBTL5jyEl.png" style="zoom:50%;" />



<h4 id="案例一：等值查询间隙锁"><a href="#案例一：等值查询间隙锁" class="headerlink" title="案例一：等值查询间隙锁"></a>案例一：等值查询间隙锁</h4><img src="https://i.loli.net/2021/01/23/otv9XOWDCjSdQcy.png" style="zoom:50%;" />

<h4 id="案例二：非唯一索引等值锁"><a href="#案例二：非唯一索引等值锁" class="headerlink" title="案例二：非唯一索引等值锁"></a>案例二：非唯一索引等值锁</h4><img src="https://i.loli.net/2021/01/23/pAhGQdrXiFV7alt.png" style="zoom:50%;" />

<ol>
<li><p>根据原则 1，加锁单位是 next-key lock，因此会给 (0,5]加上 next-key lock。</p>
</li>
<li><p>要注意 c 是普通索引，因此仅访问 c=5 这一条记录是不能马上停下来的，需要向右遍历，查到 c=10 才放弃。</p>
</li>
<li><p>根据原则 2，访问到的都要加锁，因此要给 (5,10]加 next-key lock。但是同时这个符合优化 2：等值判断，向右遍历，最后一个值不满足 c=5 这个等值条件，因此退化成间隙锁 (5,10)。</p>
</li>
<li><p>根据原则 2 ，只有访问到的对象才会加锁，这个查询使用覆盖索引，并不需要访问主键索引，所以主键索引上没有加任何锁，这就是为什么 session B 的 update 语句可以执行完成。</p>
</li>
</ol>
<p>lock in share mode只锁覆盖索引，但是如果是for update 就不一样。执行for update，会顺便给主键索引上满足条件的行加上锁。</p>
<h4 id="案例三：主键索引范围锁"><a href="#案例三：主键索引范围锁" class="headerlink" title="案例三：主键索引范围锁"></a>案例三：主键索引范围锁</h4><p>mysql&gt; select * from t where id=10 for update;<br>mysql&gt; select * from t where id&gt;=10 and id&lt;11 for update;</p>
<p>语句1，只会对语句10进行加锁</p>
<img src="https://i.loli.net/2021/01/23/fX5AJePvWgon21M.png" style="zoom:50%;" />



<p>而语句2则是行锁id =10  和 next-key（10，15】</p>
<h4 id="案例四：非唯一索引范围锁"><a href="#案例四：非唯一索引范围锁" class="headerlink" title="案例四：非唯一索引范围锁"></a>案例四：非唯一索引范围锁</h4><img src="https://i.loli.net/2021/01/23/TfeIONuZJgvLEQb.png" style="zoom:50%;" />

<p>加锁范围为(5,10] 和 (10,15] 这两个 next-key lock。</p>
<h4 id="案例五：唯一索引范围锁bug"><a href="#案例五：唯一索引范围锁bug" class="headerlink" title="案例五：唯一索引范围锁bug"></a>案例五：唯一索引范围锁bug</h4><img src="https://i.loli.net/2021/01/23/owaiyQN7k6D8P1p.png" style="zoom:50%;" />

<p>yi因为id是唯一键，所以循环判断id = 15这一行就停止了 。但是实现上，InnoDB会往前扫面第一个不满足条件的行为止，因此（16，20】这个next - key -lock也会被锁上。</p>
<h4 id="案例六：非唯一索引上存在“等值”的例子"><a href="#案例六：非唯一索引上存在“等值”的例子" class="headerlink" title="案例六：非唯一索引上存在“等值”的例子"></a>案例六：非唯一索引上存在“等值”的例子</h4><img src="https://i.loli.net/2021/01/23/CtwdR236iqPOrcD.png" style="zoom:50%;" />

<p>这时，session A 在遍历的时候，先访问第一个 c=10 的记录。</p>
<p>同样地，根据原则 1，这里加的是 (c=5,id=5) 到 (c=10,id=10) 这个 next-key lock。</p>
<p>然后，session A 向右查找，直到碰到 (c=15,id=15) 这一行，循环才结束。</p>
<p>根据优化 2，这是一个等值查询，向右查找到了不满足条件的行，所以会退化成 (c=10,id=10) 到 (c=15,id=15) 的间隙锁。</p>
<p>也就是说，这个 delete 语句在索引 c 上的加锁范围，就是下图中蓝色区域覆盖的部分。</p>
<h4 id="案例七：limit语句加锁"><a href="#案例七：limit语句加锁" class="headerlink" title="案例七：limit语句加锁"></a>案例七：limit语句加锁</h4><img src="https://i.loli.net/2021/01/23/Jrz1ZMpx7qmuvPs.png" style="zoom:50%;" />

<p>这是因为，案例七里的 delete 语句明确加了 limit 2 的限制，因此在遍历到 (c=10, id=30) 这一行之后，满足条件的语句已经有两条，循环就结束了。因此，索引 c 上的加锁范围就变成了从（c=5,id=5) 到（c=10,id=30) 这个前开后闭区间，如下图所示：</p>
<img src="https://i.loli.net/2021/01/23/Yl6UQG3g74ENCKh.png" style="zoom:50%;" />

<p><strong>在删除数据的时候尽量加limit</strong>。这样不仅可以控制删除数据的条数，让操作更安全，还可以减小加锁的范围。</p>
<h4 id="案例八：一个死锁的例子"><a href="#案例八：一个死锁的例子" class="headerlink" title="案例八：一个死锁的例子"></a>案例八：一个死锁的例子</h4><img src="https://i.loli.net/2021/01/23/CAQ7tarNwmZKEMs.png" style="zoom:50%;" />

<p>session A 启动事务后执行查询语句加 lock in share mode，在索引 c 上加了 next-key lock(5,10] 和间隙锁 (10,15)；</p>
<p>session B 的 update 语句也要在索引 c 上加 next-key lock(5,10] ，进入锁等待；</p>
<p>然后 session A 要再插入 (8,8,8) 这一行，被 session B 的间隙锁锁住。由于出现了死锁，InnoDB 让 session B 回滚。</p>
<p>其实是这样的，session B 的“加 next-key lock(5,10] ”操作，实际上分成了两步，先是加 (5,10) 的间隙锁，加锁成功；然后加 c=10 的行锁，这时候才被锁住的。</p>
<p>实际上next-key lock 来分析。具体执行的时候，要分成间隙锁和行锁两端来执行的。</p>
<p>读已提交除在外键条件下不存在间隙锁，还有个优化，即：语句执行过程中加上的行锁，在语句执行完成后，就把“不满足条件的行”上的行锁直接释放了，不需要等到事务提交。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning09.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning09.html" class="post-title-link" itemprop="url">什么是幻读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-22 20:47:34" itemprop="dateCreated datePublished" datetime="2021-01-22T20:47:34+08:00">2021-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-01-23 10:08:55" itemprop="dateModified" datetime="2021-01-23T10:08:55+08:00">2021-01-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning09.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning09.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是幻读"><a href="#什么是幻读" class="headerlink" title="什么是幻读"></a>什么是幻读</h3><img src="https://i.loli.net/2021/01/22/VCiQI2LT6zBneGM.png" style="zoom:50%;" />

<img src="https://i.loli.net/2021/01/22/hUTB4MzEsHq6mef.png" style="zoom:50%;" />

<p>1.在可重复读的级别下，普通的查询时快照读，是不会看到别的事务插入的数据的。因此，幻读在“当前读“下才会出现。</p>
<p>2.上面sessionB的修改结果，被session  A之后的select 语句用”当前读“看到，不能称为幻读。幻读仅专指”新插入的行“。</p>
<h4 id="幻读有什么问题"><a href="#幻读有什么问题" class="headerlink" title="幻读有什么问题"></a>幻读有什么问题</h4><p>1.破环了语义上的意思。”要把所有满足条件的行锁住，不准别的事务进行读写操作“</p>
<p>2.数据一致性的问题。</p>
<p>即使把所有的记录都加上锁，还是阻止不了新插入的记录。</p>
<h4 id="如何解决幻读"><a href="#如何解决幻读" class="headerlink" title="如何解决幻读"></a>如何解决幻读</h4><p>1.产生幻读的原因是，行锁只能锁住行，但是新插入这个动作，要更新记录之间的”间隙“。因此，为了解决幻读，InnoDB引入新的锁，也就是间隙锁（Gap Lock）。</p>
<img src="https://i.loli.net/2021/01/22/VhwrjMaP3b84fDo.png" style="zoom:50%;" />

<p>就这样不止给数据库中已有的6个记录加上行锁，还同时加了7个间隙锁。这样确保了无法插入新的记录。</p>
<p>跟间隙锁存在冲突关系的，是”往这个间隙中插入一个记录“这个操作。</p>
<p>间隙锁和行锁合成next-key lock，每个next-key lock是前开后闭区间。例如：分别是 (-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]。</p>
<p>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。</p>
<p>间隙锁是在可重复读隔离级别下才会生效的。如果把隔离级别设置成读提交，就没有间隙锁。但是需要解决数据和日志不一致的问题，需要把binlog格式设置为row。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning08.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning08.html" class="post-title-link" itemprop="url">order by 工作原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 20:37:19 / 修改时间：20:55:36" itemprop="dateCreated datePublished" datetime="2021-01-22T20:37:19+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning08.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning08.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="order-by工作原理"><a href="#order-by工作原理" class="headerlink" title="order by工作原理"></a>order by工作原理</h3><h4 id="全字段排序"><a href="#全字段排序" class="headerlink" title="全字段排序"></a>全字段排序</h4><p>MySQL会给每个线程分配一块内存用于排序，称为sort buffer。</p>
<p>1.初始化 sort_buffer，确定放入 name、city、age 这三个字段；</p>
<p>2.从索引 city 找到第一个满足 city=’杭州’条件的主键 id，也就是图中的 ID_X；</p>
<p>3.到主键 id 索引取出整行，取 name、city、age 三个字段的值，存入 sort_buffer 中；</p>
<p>4.从索引 city 取下一个记录的主键 id；</p>
<p>5.重复步骤 3、4 直到 city 的值不满足查询条件为止，对应的主键 id 也就是图中的 ID_Y；</p>
<p>6.对 sort_buffer 中的数据按照字段 name 做快速排序；</p>
<p>7.按照排序结果取前 1000 行返回给客户端。</p>
<p>sort_buffer_size ，就是MySQL为排序开辟的内存（sort_buffer）的大小。如果要排序的数据量小于sort_buffer_size，排序就在内存中完成。如果数据量太大，内存放不下，则不得不利用磁盘临时文件辅助排序。</p>
<img src="https://i.loli.net/2021/01/22/XrfTwBDKqWbPmFd.png" style="zoom:50%;" />

<h4 id="rowid排序"><a href="#rowid排序" class="headerlink" title="rowid排序"></a>rowid排序</h4><p>如果sort_buffer里面要存放的字段数太多，这样内存能存的行数很少，要分成很多个临时文件，排序性能会很差。可以通过修改max_length_for_sort_data的值来改变排序算法。</p>
<p>1.初始化 sort_buffer，确定放入两个字段，即 name 和 id；</p>
<p>2.从索引 city 找到第一个满足 city=’杭州’条件的主键 id，也就是图中的 ID_X；</p>
<p>3.到主键 id 索引取出整行，取 name、id 这两个字段，存入 sort_buffer 中；</p>
<p>4.从索引 city 取下一个记录的主键 id；</p>
<p>5.重复步骤 3、4 直到不满足 city=’杭州’条件为止，也就是图中的 ID_Y；</p>
<p>6.对 sort_buffer 中的数据按照字段 name 进行排序；</p>
<p>7.遍历排序结果，取前 1000 行，并按照 id 的值回到原表中取出 city、name 和 age 三个字段返回给客户端。</p>
<img src="https://i.loli.net/2021/01/22/9LYQciKfheZ5lxE.png" style="zoom:50%;" />

<h4 id="全字段排序-VS-Rowid排序"><a href="#全字段排序-VS-Rowid排序" class="headerlink" title="全字段排序 VS Rowid排序"></a>全字段排序 VS Rowid排序</h4><p>由于Rowid排序涉及到回表，如果内存足够，就优先使用内存，即全字段排序。</p>
<p>优化手段：可以使用覆盖索引，索引上的信息足够满足查询请求，不需要再回主键索引上去取数据。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning07.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning07.html" class="post-title-link" itemprop="url">MySQL 保证数据不丢失的秘密</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 20:18:12 / 修改时间：20:55:39" itemprop="dateCreated datePublished" datetime="2021-01-22T20:18:12+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning07.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning07.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="保证数据不丢失的秘密"><a href="#保证数据不丢失的秘密" class="headerlink" title="保证数据不丢失的秘密"></a>保证数据不丢失的秘密</h3><h4 id="binlog写入机制"><a href="#binlog写入机制" class="headerlink" title="binlog写入机制"></a>binlog写入机制</h4><p>binlog写入逻辑：事务执行过程中，先把日志写到binlog cache，事务提交的时候，再把binlog cache写到binlog中。</p>
<p>每个线程由自己的binlog cache ,但是共用同一份binlog文件。</p>
<p>write，指的是把日志写入文件系统的page cache,并没有把数据持久化到磁盘，所以速度快。</p>
<p>fsync，将数据持久化到磁盘的操作。</p>
<img src="https://i.loli.net/2021/01/22/unLfoqTdmyXH1pc.png" style="zoom:50%;" />

<p>write和fsync的时机，是由参数sync_binlog控制的；</p>
<p>1.sync_binlog = 0的时候，表示每次提交事务都只write，不fsync;</p>
<p>2.sync_binlog =1的时候，表示每次提交事务都会执行fsync;</p>
<p>3.sync_binlog=N(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</p>
<h4 id="redo-log的写入机制"><a href="#redo-log的写入机制" class="headerlink" title="redo log的写入机制"></a>redo log的写入机制</h4><img src="https://static001.geekbang.org/resource/image/9d/d4/9d057f61d3962407f413deebc80526d4.png" alt="img" style="zoom:50%;" />

<p>1.存在redo log buffer中，物理上是在MySQL进程内存中。</p>
<p>2.写到磁盘（write）,但是没有持久化(fsync)，物理上文件系统的page cache里面。</p>
<p>3.持久化到磁盘，对应的是hard disk。</p>
<p>InnoDB提供了innodb_flush_log_at_trx_commit参数控制redo log的写入策略。</p>
<p>0：表示每次事务提交时都只是把redo log留在redo log buffer中</p>
<p>1：表示每次事务提交都将redo log持久化硬盘</p>
<p>2：每次提交都只是把redo log写到page cache</p>
<p>InnoDB有一个后台线程，每间隔一秒，就会把redo log buffer中的日志，调用write 写到文件系统的page cache ，然后fsync持久化磁盘。</p>
<p>3种情况会把让没有提交事务的redo log写入到磁盘中</p>
<p>1.后台线程每秒一次的轮询操作。</p>
<p>2.redo log buffer占用的空间即将达到innodb_log_buffer_size一半的时候，后台线程会主动写盘。</p>
<p>3.并行的事务提交的时候，顺带将这个事务的redo log buffer持久化到磁盘。</p>
<p>MySQL的双一配置。指的就是sync_binlog和innodb_flush_log_at_trx_commit都设置成1。一个事务完整提交前，需要等待两次刷盘，一次是redo log（prepare ）,一次是binlog.</p>
<p>日志逻辑序列（LSN）是单调递增的，用来对应redo log的一个个写入点。每次写入length的redo log，LSN的值就会加上length。</p>
<p>一次组提交里面，里面的组员越多，节约磁盘IOPS的效果越好。</p>
<p>日志记录过程</p>
<img src="https://i.loli.net/2021/01/22/B2GzKH3tRJqySns.png" style="zoom:50%;" />



<p>如果想binlog提升组提交的效果，可以通过设置binlog_group_commit_sync_delay 和 binlog_group_commit_sync_no_delay_count 来实现。</p>
<p>1.binlog_group_commit_sync_delay参数，表示多少微秒后才调用fsync</p>
<p>2.binlog_group_commit_sync_no_delay_count，表示多少次以后才调用fsync</p>
<p>如果MySQL出现了性能瓶颈，而且瓶颈在IO上</p>
<p>1.通过设置binlog_group_commit_sync_delay 和 binlog_group_commit_sync_no_delay_count参数你，减少binlog的写盘速度。</p>
<p>2.将sync_binlog设置大于1，这样做的风险是，这个主机掉电会丢失binlog日志。</p>
<p>3.innodb_flush_log_at_trx_commit 设置为 2。这样做的风险是，主机掉电的时候会丢数据。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning06.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning06.html" class="post-title-link" itemprop="url">MySQL 提高性能的办法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 20:18:09 / 修改时间：20:35:08" itemprop="dateCreated datePublished" datetime="2021-01-22T20:18:09+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning06.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning06.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="MySQL-提高性能的办法"><a href="#MySQL-提高性能的办法" class="headerlink" title="MySQL 提高性能的办法"></a>MySQL 提高性能的办法</h3><p>短连接存在的一个风险，就是一旦数据库处理得慢一些，连接数就会暴涨。</p>
<p>max_connection参数，用来控制一个MySQL最大连接数，超过这个值，系统就会提示“too many connections”从而导致数据库不可用。</p>
<p>解决方案</p>
<p>1.先处理掉那些占着链接但是不工作的线程。</p>
<p>如果连接数过多，可以优先断开事务外空闲太久的链接；如果这样还不够，在考虑断开事务内空闲太久的链接。</p>
<p>使用 kill connection + id的方式，使用show processlist查看结果。</p>
<p>2.减少连接过程的消耗</p>
<p>跳过权限验证的方法是：重启数据库，并使用-skip-grant-tables参数启动。这样连接过程和语句执行过程都会跳过权限校验阶段。(但是不建议这么做，风险极高)。</p>
<h4 id="慢查询性能问题"><a href="#慢查询性能问题" class="headerlink" title="慢查询性能问题"></a>慢查询性能问题</h4><p>1.索引没有设计好</p>
<p>2.SQL语句没写好</p>
<p>3.MySQL选错了索引</p>
<p>1.上线前，在测试环境，把慢查询日志打开，并且把long_query_time设置成0，确保每个语句都会被记录</p>
<p>2.在测试表插入线上的数据，做一遍回归测试</p>
<p>3.观察慢查询里每类语句的输出，特别留意Row_examined字段是否一致。</p>
<p>call query_rewrite.flush_rewrite_rules() 这个存储过程，是让插入的新规则生效，也就是我们说的“查询重写”。</p>
<h4 id="QPS突增问题"><a href="#QPS突增问题" class="headerlink" title="QPS突增问题"></a>QPS突增问题</h4><p>1.如果是由全新业务的bug导致的，那么就可以从数据库直接把白名单去掉。</p>
<p>2.如果这个新功能使用的单独的数据库用户，可以直接删除用户。</p>
<p>3.如果跟主题功能绑定在一块，使用语句重写的功能，把压力最大的SQL直接重写成“select 1”返回。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning05.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning05.html" class="post-title-link" itemprop="url">数据表空间回收</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 19:50:10 / 修改时间：20:11:35" itemprop="dateCreated datePublished" datetime="2021-01-22T19:50:10+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning05.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning05.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="数据表空间回收"><a href="#数据表空间回收" class="headerlink" title="数据表空间回收"></a>数据表空间回收</h3><p>MySQL8.0版本前，表的结构是存在以.frm为后缀的文件里。而8.0后，允许把表结构定义放在系统数据表中。因为结构定义占用的空间很小。</p>
<p>表数据既可以存在共享表空间里面，也可以是单独的文件。这个行为是由参数innodb_file_per_table控制。从Mysql5.6.6以后，默认为on。</p>
<p>off：表的数据放在系统共享表空间，也就是跟数据字典放在一起；</p>
<p>on：每个InnoDB表数据存储在一个以.idb为后缀的文件中。</p>
<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><p>删除一个数据页上的所有记录，整个数据页的复用跟记录的复用是不同的。</p>
<p>使用delete 命令只是把记录或者数据页标记为“可复用”，不能回收表的空间，而没有使用的空间，看起来就像空洞，不止删除数据回暖造成空洞，插入数据也会。</p>
<h4 id="重建表"><a href="#重建表" class="headerlink" title="重建表"></a>重建表</h4><p>新建一个与原表结构相同的新表，然后按照主键ID递增的顺序，把数据一行一行地从原表读到表B，然后用B替换A，从而起到收缩表A空间的作用，解决空洞的问题。</p>
<p>在MySQL5.5之后，可以之前使用alter table A engine = InnoDB来重建表。</p>
<img src="https://i.loli.net/2021/01/22/sh7lNaZ1xGMFi9k.png" style="zoom:50%;" />

<p>在这个过程中，如果有新数据要写入表A的话，就回造成数据丢失。</p>
<p>为了保证整个重建表的正常，原表不能进行更新，5.6版本后引入了Online DDL，优化了该过程。</p>
<h4 id="Online-DDL"><a href="#Online-DDL" class="headerlink" title="Online DDL"></a>Online DDL</h4><p>1.建立一个临时文件，扫描表A主键的所有数据页。</p>
<p>2.用数据页中表A的记录生成B+树，存储到临时文件中。</p>
<p>3.生成的临时文件的过程中，将所有对A的操作记录再一个日志文件（row  log）中。</p>
<p>4.临时文件生成后，将日志文件的操作应用到临时文件中，得到与表A相同的数据文件。</p>
<p>5.用临时文件替换表A的数据文件。</p>
<p>整个过程中，MDL的写锁会转化为MDL的读锁，从而提高效率。</p>
<p>整个过程很消耗CPU和IO,如果想安全操作，推荐使用gh-os来做。</p>
<h5 id="Online和inplace-的区别"><a href="#Online和inplace-的区别" class="headerlink" title="Online和inplace 的区别"></a>Online和inplace 的区别</h5><p>对于server层没有把数据移动到临时表，是一个“原地”操作，这就过程称为inplace。</p>
<p>1.DDL过程如果是Online的，就一定是inplace的</p>
<p>2.inplace的DDL，有可能不是Online的。8.0后添加全文索引（FULLTEXT index）和空间索引（SPATIAL index）就属于这种情况。</p>
<h5 id="optimize-table、analyze-table和alter-table三种重建表的区别"><a href="#optimize-table、analyze-table和alter-table三种重建表的区别" class="headerlink" title="optimize table、analyze table和alter table三种重建表的区别"></a>optimize table、analyze table和alter table三种重建表的区别</h5><p>1.从MySQL 5.6版本开始，alter table t engine = InnoDB默认就是Online DDL。</p>
<p>2.analyze table t，只是对索引信息进行重新统计，没有修改数据，加入MDL读锁。</p>
<p>3.optimize table = analyze  + alter</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning04.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning04.html" class="post-title-link" itemprop="url">count(*)很“慢”？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 19:35:58 / 修改时间：19:47:00" itemprop="dateCreated datePublished" datetime="2021-01-22T19:35:58+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning04.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning04.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="count-很“慢”？"><a href="#count-很“慢”？" class="headerlink" title="count(*)很“慢”？"></a>count(*)很“慢”？</h3><h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><p>1.MyISAM引擎把一个表的总行数存在磁盘上，执行count(*)的时候会直接返回这个数。</p>
<p>2.InnoDB时，则需要一行一行的从引擎里面读出来，然后累计计数。</p>
<p>对于count(*)这样的操作，MySQL优化器会找到最小的那棵树来遍历。再保证逻辑正确的前提下，尽量减少扫描的数据量，是数据库系统设计的通用法则之一。</p>
<p>show table status命令是采用采样估计来估算的，不能直接使用。</p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>1.通过缓存保存计数。</p>
<p>将计数保存在缓存系统中的方式，还不只是丢失更新的问题。即使Redis 正常工作，这个值还是逻辑上不精确的。</p>
<p>2.在数据库保存计数</p>
<p>由于事务的可见性，可保证逻辑上的数据的一致性。</p>
<h4 id="不同count的用法"><a href="#不同count的用法" class="headerlink" title="不同count的用法"></a>不同count的用法</h4><p>count()函数的参数不是NULL，累计值就加1，否则不加。最后返回累计值。</p>
<p>count(*)，count(主键)，count(1)，count(字段)的区别</p>
<p>count(主键id)，遍历每一行把每一行的id值取出来，返回给id层，server层拿到id后，判断不为空，则按行累加。</p>
<p>count(1),server层对于返回的每一行，放一个数字“1”进去，按行累加。</p>
<p>count(字段)：一行一行的从记录里面读取字段</p>
<p>1.定义为not null的话，一行行的从记录里面读出这个字段，判断不能为null，按行累加。</p>
<p>2.定义为允许null，那么执行的时候，判断到有可能是null，还要把值取出来判断一下，不是null才累加。</p>
<p>count(*),并不会把全部字段取出来，而是专门做了优化，不取值。</p>
<p>按照效率排序的话：count(字段)&lt;count(主键 id)&lt;count(1)≈count(*)。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning03.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning03.html" class="post-title-link" itemprop="url">SQL慢的原因和解决办法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 19:22:59 / 修改时间：20:54:09" itemprop="dateCreated datePublished" datetime="2021-01-22T19:22:59+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning03.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning03.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="SQL执行过慢的原因"><a href="#SQL执行过慢的原因" class="headerlink" title="SQL执行过慢的原因"></a>SQL执行过慢的原因</h3><h4 id="1-查询长时间不返回"><a href="#1-查询长时间不返回" class="headerlink" title="1.查询长时间不返回"></a>1.查询长时间不返回</h4><ul>
<li>等待MDL锁</li>
</ul>
<p>mysql&gt; select * from t where id=1;</p>
<p>一般是表t被锁住了。可以利用show processlist看看语句处于什么状态。</p>
<p>如果是Waiting for table metadata lock的示意图，则表示有一个线程正在表t上请求或者持有MDL写锁。</p>
<p>通过查询sys.schema_table_lock_waits这张表，我们可以直接找到阻塞进程的id，然后把这个链接kill掉。  </p>
<ul>
<li>等flush</li>
</ul>
<p>有一个线程正要对表t做flush操作，MySQL里面对表做flush操作的用法。</p>
<p>flush tables t with read lock;</p>
<p>flush tables with read lock;</p>
<p>这个两个flush语句，如果制定表 t 的话，代表的只关闭表t，如果没有指定具体的表名，则表示关闭MySQL里所有打开的表。</p>
<p>所以出现Waiting for table flush 状态的可能情况是：有一个命令被别的语句堵住，然后它有堵住了我们select的语句。</p>
<p><img src="https://i.loli.net/2021/01/22/2qgHDfrzZEtPGjC.png"></p>
<ul>
<li>等行锁</li>
</ul>
<p>如果一个事务在这行记录上面上持有一个写锁，那么我们的select 语句就会被堵住。</p>
<p><img src="https://i.loli.net/2021/01/22/6HhCZGowEaSjlqe.png"></p>
<p>可以通过sys.innodb_lock_waits表查到。</p>
<h4 id="2-查询慢"><a href="#2-查询慢" class="headerlink" title="2.查询慢"></a>2.查询慢</h4><p>1.没有索引</p>
<p>2.为了一致性读，undo log日志过长导致的，判断是不是有长事务。</p>
<h3 id="SQL为什么突然变“慢”"><a href="#SQL为什么突然变“慢”" class="headerlink" title="SQL为什么突然变“慢”"></a>SQL为什么突然变“慢”</h3><p>当内存数据页和磁盘数据页内容不一致的时候，我们称这个内存页为“脏页”。内存数据写入到磁盘后，内存和磁盘的数据页的内容就一直了，称为“干净页”。刷新脏页的过程为称为flush。</p>
<h4 id="flush的4种场景"><a href="#flush的4种场景" class="headerlink" title="flush的4种场景"></a>flush的4种场景</h4><p>1.对于InnoDB 的redo log写满了。</p>
<p>2.对应的系统内存不足。在需要新的内存页，而内存不够用的时候，就要淘汰一些数据页，空出内存给别的数据页使用。如果淘汰的时“脏页”，则先写入磁盘。</p>
<p>3.MySQL会合理的安排时间，见缝插针的刷新“脏页”。</p>
<p>4.MySQL重启的时候。</p>
<p>刷新脏页虽然时常态，但都是明显影响性能的。</p>
<p>1.一个查询要淘汰的脏页过多，会导致查询的响应时间明显变长。</p>
<p>2.日志写满，更新性能全部堵住，写性能跌为0，这种情况对敏感的业务来说，不能接受。</p>
<h4 id="InnoDB刷新脏页的控制策略"><a href="#InnoDB刷新脏页的控制策略" class="headerlink" title="InnoDB刷新脏页的控制策略"></a>InnoDB刷新脏页的控制策略</h4><p>1.调用fio工具，来正确设置innodb_io_capacity的这个参数</p>
<p>Innodb的刷盘速度主要考虑两个因素：一个脏页比例，一个是redo log写盘速度。</p>
<img src="https://i.loli.net/2021/01/22/p6tYAvMoGwkPUW2.png" style="zoom:50%;" />

<p>合理设置innodb_io_capacity的值，并且多关注脏页比例，**不要让它接近75%**。</p>
<p>脏页的比例是通过Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_total得到的</p>
<p>其中innodb_flush_neighbors 参数为1会顺带把邻居的脏页同步刷新，适用于机械硬盘的场景。5.8以后默认</p>
<p>innodb_flush_neighbors 为0。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sunskey.top/mysql-learning02.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Sunskey">
      <meta itemprop="description" content="做时间的朋友">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunskey">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/mysql-learning02.html" class="post-title-link" itemprop="url">MySQL 索引相关知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-01-22 19:08:42 / 修改时间：20:36:50" itemprop="dateCreated datePublished" datetime="2021-01-22T19:08:42+08:00">2021-01-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/mysql-learning02.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/mysql-learning02.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="MySQL-索引相关知识"><a href="#MySQL-索引相关知识" class="headerlink" title="MySQL 索引相关知识"></a>MySQL 索引相关知识</h3><h4 id="索引的选择"><a href="#索引的选择" class="headerlink" title="索引的选择"></a>索引的选择</h4><h5 id="查询过程"><a href="#查询过程" class="headerlink" title="查询过程"></a>查询过程</h5><p>普通索引：在查找满足条件的第一个记录后，查找下一个记录你，直到碰到不满足的条件的记录。</p>
<p>唯一索引：在查找第一个满足条件的记录后，就会停止继续检索。</p>
<h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><p>唯一索引的更新不能使用change buffer。而普通索引则可以。</p>
<p>索引的选择，两类索引在查询性能上没差别的，主要是考虑对更新的性能。推荐使用普通索引。</p>
<h5 id="changebuffer"><a href="#changebuffer" class="headerlink" title="changebuffer"></a>changebuffer</h5><p>定义：当需要更新一个数据的时候，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话，在不影响数据一致性的前提下，InnoDB将会将这些更新操作缓存在change buffer中，这样就不需要从磁盘中读入数据页了。在下次查询需要访问这个数据页的时候，将数据读入内存，然后执行change buffer中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性。</p>
<p>作用：减少读磁盘，语句的执行速度会得到明显的提升 ，提高内存利用率。</p>
<p>change buffer的时使用场景：主要目的就是将记录的变更动作缓存下来，在一个数据页做merge之前，记录的越多，收益越大。对于写多读少的业务（例如：账单类、日志类）使用效果较好。但是对于写入之后马上会做查询的场景。由于更新之后马上会读取数据页，出发merge的过程，这样反而会增加change buffer的维护代价。</p>
<p>change buffer:是buffer poll里面的内存，可以通过innodb_change_buffer_max_size去设置。</p>
<p>changebuffer和 redo log的区别</p>
<p>redo log主要节省的是随机磁盘的IO消耗（转化顺序写），而change buffer主要节省的是随机读磁盘的IO的消耗。</p>
<h4 id="MySQL索引的错误选择"><a href="#MySQL索引的错误选择" class="headerlink" title="MySQL索引的错误选择"></a>MySQL索引的错误选择</h4><p>优化器选择扫描行数、临时表，是否排序等因素综合找出一个最优的解决方案，用最小的代价去执行语句。</p>
<p>扫行行数：通过“区分度”来建立估算扫描行数，显然“基础”越大，索引的区分度越好。</p>
<p>通过show index from table 中cardinality属性可以得到区分度。</p>
<p>采用统计：InnoDB会默认选择N个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到这个索引的基数。当变更行数超过1/M的时候，会自动触发重新做一次索引统计。</p>
<p>在MySQL中，有两种存储索引的统计方式，可通过innodb_stats_persistent的值来选择。</p>
<p>on:持久化存储。默认N是20，M是10。</p>
<p>off:内存。默认N是8，M是16。</p>
<h5 id="索引选择异常和处理"><a href="#索引选择异常和处理" class="headerlink" title="索引选择异常和处理"></a>索引选择异常和处理</h5><p>1.采用force index强行选择索引。</p>
<p>2.修改语句，引导MySQL使用我们期望的索引。</p>
<p>3.在有些场景下，我们可以新建一个索引，提供给优化器做选择或者删除误用的索引。</p>
<h4 id="字符串加索引"><a href="#字符串加索引" class="headerlink" title="字符串加索引"></a>字符串加索引</h4><p>mysql&gt; alter table SUser add index index1(email);<br>mysql&gt; alter table SUser add index index2(email(6));</p>
<p>select id,name,email from SUser where email=’zhangssxyz@xxx.com’;</p>
<h5 id="如果使用全索引"><a href="#如果使用全索引" class="headerlink" title="如果使用全索引"></a>如果使用全索引</h5><p>1.从index1索引树找到满足索引值”zhangssxyz”的这条记录，取得ID2的值</p>
<p>2.到主键查到主键值是ID2的行，判断email的值是否正确，将这行记录加入结果集</p>
<p>3.取index1索引树上刚刚查到的位置的下一条记录，发现不满足email=’zhangssxyz@xxx.com’的条件，循环结束。</p>
<h5 id="使用部分索引"><a href="#使用部分索引" class="headerlink" title="使用部分索引"></a>使用部分索引</h5><p>1.从index2 索引树找到满足索引值“zhangs”的记录，找到一个是ID!;</p>
<p>2.到主键查询主键值ID1的行，判断email的值不是“<a href="mailto:&#122;&#x68;&#97;&#x6e;&#x67;&#x73;&#115;&#115;&#64;&#120;&#x78;&#120;&#x2e;&#x63;&#x6f;&#109;">&#122;&#x68;&#97;&#x6e;&#x67;&#x73;&#115;&#115;&#64;&#120;&#x78;&#120;&#x2e;&#x63;&#x6f;&#109;</a>”，丢弃。</p>
<p>3.取index2刚刚位置的下一条记录，发现仍然是“zhangs”，取出ID2，回表判断值是否正确，加入结果集</p>
<p>4.重复上述操作，直到在index2上取到的值不是“zhangs”时，循环结束</p>
<p>使用好前缀索引，定义好长度，就可以做好既节约空间，又不用额外增加太多的查询成本。</p>
<p>mysql&gt; select<br>  count(distinct left(email,4)）as L4,<br>  count(distinct left(email,5)）as L5,<br>  count(distinct left(email,6)）as L6,<br>  count(distinct left(email,7)）as L7,<br>from SUser;</p>
<p>在L4-L7中，找出不小于L*95%的值。</p>
<p>使用前缀索引就用不上覆盖索引的查询性能的优化了。</p>
<h5 id="字符串索引的劣势"><a href="#字符串索引的劣势" class="headerlink" title="字符串索引的劣势"></a>字符串索引的劣势</h5><p>对于区分度不高的场景，例如身份证前6位对于一个市、县区分度并不高的解决方案。</p>
<p>1.使用倒序存储</p>
<p>2.使用hash字段</p>
<p>hash字段和倒序存储的区别</p>
<p>1.倒序存储不消耗额外的空间，不需要新增hash字段。</p>
<p>2.自增hash字段的方式，倒序rerverse()相比hash函数的效率更高。</p>
<p>3.从查询效率上看，使用hash字段方式的查询性能相对稳定。</p>
<h4 id="索引的失效"><a href="#索引的失效" class="headerlink" title="索引的失效"></a>索引的失效</h4><p>1.对索引字段做函数操作，可能会破环索引值的有序性，因此优化器就决定放弃走树搜索功能。</p>
<p>2.隐式的类型转换</p>
<p>3.隐式的字符编码转化</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sunskey"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Sunskey</p>
  <div class="site-description" itemprop="description">做时间的朋友</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

   <div class="feed-link motion-element">
     <a href="/atom.xml" rel="alternate">
       <i class="fa fa-rss"></i>
       RSS
     </a>
   </div>

  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sunskey" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sunskey" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:154218965@qq.com" title="E-Mail → mailto:154218965@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sunskey</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'IeQnDEu3RFIAA4RTfDqdXeV2-gzGzoHsz',
      appKey     : 'eSw8Svi50Fp5BMlPaiSS02nv',
      placeholder: "快来发表自己的评论吧",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
    //新增以下代码即可，可以移除.info下所有子节点。
var infoEle = document.querySelector('#valine-comments .vpower');
infoEle.style.display='none'; 
 }, window.Valine);
});


</script>

</body>
</html>
